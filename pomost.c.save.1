#include <stdlib.h>
#include <string.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <fcntl.h>
#include <unistd.h>
#include <time.h>

#define MSG_KEY 1234
#define MAX_TEXT 128

struct msgbuf {
    long mtype;
    char mtext[MAX_TEXT];
};

void log_message(const char *format, ...) {
    va_list args;
    va_start(args, format);

    char time_buffer[20];
    time_t now = time(NULL);
    strftime(time_buffer, sizeof(time_buffer), "%H:%M:%S", localtime(&now));

    printf("[%s] ", time_buffer);
    vprintf(format, args);
    printf("\n");

    va_end(args);
}

int main() {
    log_message("Uruchamiam pomost. Obsługujemy Pomost 1 i Pomost 2.");

    int msqid = msgget(MSG_KEY, 0666);
    if (msqid < 0) {
        perror("[Pomost] Błąd otwierania kolejki komunikatów");
        return EXIT_FAILURE;
    }

    struct msgbuf message;
    while (1) {
        memset(&message, 0, sizeof(message));

        // Odbieranie komunikatu
        if (msgrcv(msqid, &message, sizeof(message.mtext), 0, 0) < 0) {
            perror("[Pomost] Błąd odbierania wiadomości");
            continue;
        }

        // Parsowanie komunikatu
        log_message("Otrzymano komunikat: '%s'", message.mtext);

        int boat_num, pid1, pid2 = 0, age1, age2 = 0;
        int parsed = 0;

        if (message.mtype == 1) {
            // Pasażer indywidualny: '1 <PID> <wiek> <wolne_miejsca>'
            parsed = sscanf(message.mtext, "1 %d %d %d", &pid1, &age1, &boat_num);
            if (parsed == 3) {
                log_message("Pasażer PID: %d, wiek: %d przeszedł na statek: %d.", pid1, age1, boat_num);
            } else {
                log_message("Błąd parsowania komunikatu pasażera indywidualnego: '%s'", message.mtext);
            }
        } else if (message.mtype == 2) {
            // Rodzic z dzieckiem: '2 <PID rodzica> <PID dziecka> <wiek rodzica> <wiek dziecka>'
            parsed = sscanf(message.mtext, "2 %d %d %d %d", &pid1, &pid2, &age1, &age2);
            if (parsed == 4) {
                log_message("Rodzic PID: %d, wiek: %d oraz dziecko PID: %d, wiek: %d przeszli na statek: %d.", 
                            pid1, age1, pid2, age2, boat_num);
            } else {
                log_message("Błąd parsowania komunikatu rodzica z dzieckiem: '%s'", message.mtext);
            }
        } else {
            log_message("Nieznany typ komunikatu: '%ld'. Oczekiwano 1 lub 2.", message.mtype);
        }
    }

    return 0;
}

